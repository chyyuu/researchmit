(function(e,t){function $(e,t){for(var n in t)t[n]&&(e[n]?e[n].set(t[n]):e[n]=new I(t[n]))}function J(){return R.data.user_id==0}if(e.DUOSHUO)return;var n=e.document,r=n.getElementsByTagName("head")[0]||n.getElementsByTagName("body")[0],i=n.createElement("input"),s=e.navigator.userAgent,o=0,u,a=function(){var e={"<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},t=/&(?!\w+;)|[<>"'`]/g,n=/[&<>"'`]/,r=function(t){return e[t]||"&amp;"};return function(e){return e==null||e===!1?"":n.test(e)?e.replace(t,r):e}}(),f={start:0,end:0},l=function(e){var t=this,r=0,i=0,s,o,u,a,l;n.selection&&(o=n.selection.createRange(),o&&o.parentElement()==t&&(a=t.value.length,s=t.value.replace(/\r\n/g,"\n"),u=t.createTextRange(),u.moveToBookmark(o.getBookmark()),l=t.createTextRange(),l.collapse(!1),u.compareEndPoints("StartToEnd",l)>-1?r=i=a:(r=-u.moveStart("character",-a),r+=s.slice(0,r).split("\n").length-1,u.compareEndPoints("EndToEnd",l)>-1?i=a:(i=-u.moveEnd("character",-a),i+=s.slice(0,i).split("\n").length-1)))),f.start=r,f.end=i},c=function(e){return function(){return e}},h=e.DUOSHUO={DOMAIN:"duoshuo.com",REMOTE:"http://duoshuo.com",STATIC:"http://static.duoshuo.com",EMBED_STYLESHEET:"/styles/embed.css?21303059.css",version:130130,loaded:{jQuery:typeof jQuery!="undefined"&&jQuery.fn.jquery>="1.5",smilies:!1},libs:{jQuery:"/libs/embed.compat.js",smilies:"/libs/smilies.js?a8888a84.js"},sourceName:{weibo:"\u65b0\u6d6a\u5fae\u535a",qq:"QQ",qzone:"QQ\u7a7a\u95f4",qqt:"\u817e\u8baf\u5fae\u535a",renren:"\u4eba\u4eba\u7f51",douban:"\u8c46\u74e3\u7f51",netease:"\u7f51\u6613\u5fae\u535a",kaixin:"\u5f00\u5fc3\u7f51",sohu:"\u641c\u72d0\u5fae\u535a",baidu:"\u767e\u5ea6",taobao:"\u6dd8\u5b9d",msn:"MSN",google:"\u8c37\u6b4c"},serviceNames:{weibo:"\u5fae\u535a",qq:"QQ",douban:"\u8c46\u74e3",renren:"\u4eba\u4eba",netease:"\u7f51\u6613",kaixin:"\u5f00\u5fc3",sohu:"\u641c\u72d0",baidu:"\u767e\u5ea6",taobao:"\u6dd8\u5b9d",msn:"MSN",google:"\u8c37\u6b4c"},parseDate:function(e){return e.parse("2011-10-28T00:00:00+08:00")&&function(t){return new e(t)}||e.parse("2011/10/28T00:00:00+0800")&&function(t){return new e(t.replace(/-/g,"/").replace(/:(\d\d)$/,"$1"))}||e.parse("2011/10/28 00:00:00+0800")&&function(t){return new e(t.replace(/-/g,"/").replace(/:(\d\d)$/,"$1").replace("T"," "))}||function(t){return new e(t)}}(Date),fullTime:function(e){var t=h.parseDate(e);return t.getFullYear()+"\u5e74"+(t.getMonth()+1)+"\u6708"+t.getDate()+"\u65e5 "+t.toLocaleTimeString()},elapsedTime:function(e){var t=h.parseDate(e),n=new Date,r=(n-o-t)/1e3;return r<10?"\u521a\u521a":r<60?Math.round(r)+"\u79d2\u524d":r<3600?Math.round(r/60)+"\u5206\u949f\u524d":r<86400?Math.round(r/3600)+"\u5c0f\u65f6\u524d":(n.getFullYear()==t.getFullYear()?"":t.getFullYear()+"\u5e74")+(t.getMonth()+1)+"\u6708"+t.getDate()+"\u65e5"},require:function(e,t){if(typeof e=="string")h.loaded[e]?t():C(h.STATIC+h.libs[e],function(){h.loaded[e]=!0,t()});else if(typeof e=="object"){var n,r=!0;for(n=0;n<e.length;n++)(function(i){if(h.loaded[e[n]])return;r=!1,C(h.STATIC+h.libs[i],function(){h.loaded[i]=!0;for(var n=0;n<e.length;n++)if(!h.loaded[e[n]])return;t()})})(e[n]);r&&t()}},param:function(e){var n=[];for(var r in e)e[r]!=t&&n.push(r+"="+encodeURIComponent(e[r]));return n.join("&")},ajax:function(n,r,i,s,o){i.v=h.version,M.remote_auth&&(i.remote_auth=M.remote_auth);if(e.XMLHttpRequest&&e.JSON&&e.JSON.parse){var u=new e.XMLHttpRequest;if(!!u&&"withCredentials"in u){var a;function f(t,n,r,i){var u,a,f,l=n;if(t>=200&&t<300||t===304)if(t===304)l="notmodified",u=!0;else try{a=e.JSON.parse(r),l="success",u=!0}catch(c){l="parsererror",f=c}else{f=l;if(!l||t)l="error",t<0&&(t=0);try{a=e.JSON.parse(r)}catch(c){l="parsererror",f=c}}u?s(a):l==="parseerror"?k("\u89e3\u6790\u9519\u8bef: "+r):(o&&o(a),k("\u51fa\u9519\u5566("+a.code+"): "+a.errorMessage),a.errorTrace&&k(a.errorTrace))}u.open(n,h.hostUrl+r+".json"+(n=="GET"?"?"+h.param(i):""),!0),u.withCredentials=!0,u.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),u.send(n=="GET"?null:h.param(i)),a=function(e,n){var r,i,s,o;try{if(a&&(n||u.readyState===4)){a=t;if(n)u.readyState!==4&&u.abort();else{r=u.status,s=u.getAllResponseHeaders();try{o=u.responseText}catch(e){}try{i=u.statusText}catch(l){i=""}}}}catch(c){n||f(-1,c)}o&&f(r,i,o,s)},u.readyState===4?a():u.onreadystatechange=a;return}}n!="GET"&&(i._method="POST");var l="cb_"+Math.round(Math.random()*1e6);h[l]=function(e){switch(e.code){case 0:s(e);break;default:o&&o(e),k("\u51fa\u9519\u5566("+e.code+"): "+e.errorMessage),e.errorTrace&&k(e.errorTrace)}},i.callback="DUOSHUO['"+l+"']",C(h.hostUrl+r+".jsonp?"+h.param(i))},injectStylesheet:function(e){var t=n.createElement("link");t.type="text/css",t.rel="stylesheet",t.href=e,r.appendChild(t)},setCustomStyle:function(e){u||(u=n.createElement("style"),u.type="text/css",r.appendChild(u)),e=e.replace(/\}/g,"}\n");if(u.styleSheet)u.styleSheet.cssText=e;else{while(u.firstChild)u.removeChild(u.firstChild);u.appendChild(n.createTextNode(e))}},compileStyle:function(e){var t="",n={textbox:"#ds-thread #ds-reset .ds-textarea-wrapper"};if(e)for(var r in e)t+=n[r]+"{"+e[r]+"}\n";return t},init:function(e,t){e&&!g[e]&&(g[e]=t||{type:"EmbedThread"}),h.initView&&h.initView()}},p=n.all,d=!e.XMLHttpRequest&&typeof i.style.maxHeight=="undefined",v=h.support={placeholder:"placeholder"in i,localStorage:function(e){try{return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch(t){return!1}},iOS:s.match(/ \((iPad|iPhone|iPod);( U;)? CPU( iPhone)? OS /),android:s.match(/ \(Linux; U; Android /)},m=function(e,t){var r=(n.body||n.documentElement).style;if(typeof r=="undefined")return!1;if(typeof r[e]=="string")return t?e:!0;var i=["Moz","Webkit","ms"],e=e.charAt(0).toUpperCase()+e.substr(1),s=0;for(;s<i.length;s++)if(typeof r[i[s]+e]=="string")return t?i[s]+e:!0},g=h.selectors={".ds-thread":{type:"EmbedThread"},".ds-recent-comments":{type:"RecentComments"},".ds-recent-visitors":{type:"RecentVisitors"},".ds-top-users":{type:"TopUsers"},".ds-top-threads":{type:"TopThreads"},".ds-login":{type:"LoginWidget"},".ds-thread-count":{type:"ThreadCount"}},y=h.pagelets=[],b={post:"\u53d1\u5e03",posting:"\u6b63\u5728\u53d1\u5e03",settings:"\u8bbe\u7f6e",reply:"\u56de\u590d",like:"\u9876",repost:"\u8f6c\u53d1",report:"\u4e3e\u62a5","delete":"\u5220\u9664",reply_to:"\u56de\u590d ",reposts:"\u8f6c\u53d1",comments:"\u8bc4\u8bba",floor:"\u697c",latest:"\u6700\u65b0",earliest:"\u6700\u65e9",hottest:"\u6700\u70ed",share_to:"\u5206\u4eab\u5230:",leave_a_message:"\u8bf4\u70b9\u4ec0\u4e48\u5427\u2026",repost_reason:"\u8bf7\u8f93\u5165\u8f6c\u53d1\u7406\u7531",hot_posts_title:"\u88ab\u9876\u8d77\u6765\u7684\u8bc4\u8bba",comments_zero:"\u6682\u65e0\u8bc4\u8bba",comments_one:"1\u6761\u8bc4\u8bba",comments_multiple:"{num}\u6761\u8bc4\u8bba",reposts_zero:"\u6682\u65e0\u8f6c\u53d1",reposts_one:"1\u6761\u8f6c\u53d1",reposts_multiple:"{num}\u6761\u8f6c\u53d1",weibo_reposts_zero:"\u6682\u65e0\u65b0\u6d6a\u5fae\u535a",weibo_reposts_one:"1\u6761\u65b0\u6d6a\u5fae\u535a",weibo_reposts_multiple:"{num}\u6761\u65b0\u6d6a\u5fae\u535a",qqt_reposts_zero:"\u6682\u65e0\u817e\u8baf\u5fae\u535a",qqt_reposts_one:"1\u6761\u817e\u8baf\u5fae\u535a",qqt_reposts_multiple:"{num}\u6761\u817e\u8baf\u5fae\u535a"},w=function(e,t,n,r){h.ajax("GET",e,t,n,r)},E=function(e,t,n,r){h.ajax("POST",e,t,n,r)},S=h.Collections={},x=h.Views={},T=h.Callbacks={},N=h.openDialog=function(e){return h.dialog!==t&&h.dialog.el.remove(),h.dialog=(new x.Dialog('<div class="ds-dialog"><div class="ds-dialog-inner ds-rounded"><div class="ds-dialog-body">'+e+'</div><div class="ds-dialog-footer"><a href="http://duoshuo.com/" target="_blank" class="ds-logo"></a><span>\u793e\u4f1a\u5316\u8bc4\u8bba\u6846</span></div><a class="ds-dialog-close" href="javascript:void(0)" title="\u5173\u95ed"></a></div></div>')).open()},C=h.injectScript=function(r,i){var s=n.createElement("script"),o=n.head||n.getElementsByTagName("head")[0]||n.documentElement;s.type="text/javascript",s.src=r,s.async="async",s.charset="utf-8",s.onload=s.onreadystatechange=function(n,r){if(r||!s.readyState||/loaded|complete/.test(s.readyState))s.onload=s.onreadystatechange=null,o&&s.parentNode&&o.removeChild(s),s=t,!r&&i&&i.call(e)},o.insertBefore(s,o.firstChild)},k=h.log=function(e){typeof console=="object"&&console.log(e)},L=h.smilies={},A=["EmbedThread","RecentComments","RecentVisitors","TopUsers","TopThreads","LoginWidget","ThreadCount"],O=0,M,_=function(){M=e.duoshuoQuery;if(!M)return!1;h.hostUrl=M.short_name?"http://"+M.short_name+"."+h.DOMAIN:h.REMOTE},D=h.templates={userUrl:function(e){return e.url},avatarUrl:function(e,t){return e.avatar_url||q.data.default_avatar_url},userAnchor:function(e){var t=D.userUrl(e);return t?'<a rel="nofollow author" target="_blank" href="'+a(t)+'">'+a(e.name)+"</a>":a(e.name)},avatarImg:function(e,t){return'<img src="'+a(D.avatarUrl(e,t))+'" alt="'+a(e.name)+'"'+(t?' style="width:'+t+"px;height:"+t+'px"':"")+"/>"},avatar:function(e,t){var n=D.avatarImg(e,t),r=D.userUrl(e);return r?'<a rel="nofollow author" target="_blank" href="'+a(r)+'" title="'+a(e.name)+'">'+n+"</a>":n},timeHtml:function(e,t){return e?t?'<a href="'+t+'" target="_blank" rel="nofollow" class="ds-time" datetime="'+e+'" title="'+h.fullTime(e)+'">'+h.elapsedTime(e)+"</a>":'<span class="ds-time" datetime="'+e+'" title="'+h.fullTime(e)+'">'+h.elapsedTime(e)+"</span>":""},serviceIcon:function(e,t){return'<a href="javascript:void(0)" class="ds-service-icon ds-'+e+(t?" ds-"+e+"-active":"")+'" data-service="'+e+'" title="'+h.sourceName[e]+'"></a>'},loginButtons:function(e){return'<div class="ds-login-buttons"><p>\u793e\u4ea4\u5e10\u53f7\u767b\u5f55:</p><div class="ds-social-links">'+D.serviceList()+D.additionalServices()+"</div></div>"},poweredBy:function(e){return'<p class="ds-powered-by"><a href="http://duoshuo.com" target="_blank" rel="nofollow">'+a(e)+"</a></p>"},indicator:c('<div id="ds-indicator"></div>'),waitingImg:c('<div id="ds-waiting"></div>'),serviceList:function(e){var t='<ul class="ds-service-list">',n=["weibo","qq","renren","douban"],r=0;for(;r<n.length;r++)t+=D.loginItem(n[r],e);return t+'<li><a class="ds-more-services" href="javascript:void(0)">\u66f4\u591a\u00bb</a></li>'+"</ul>"},additionalServices:function(e){var t='<ul class="ds-service-list ds-additional-services">',n=["kaixin","netease","sohu","baidu","google"],r=0;for(;r<n.length;r++)t+=D.loginItem(n[r],e);return t+"</ul>"},loginItem:function(e,t){var n=D[t?"bindUrl":"loginUrl"](e);return'<li><a href="'+n+'" rel="nofollow" class="ds-service-link ds-'+e+'-active">'+h.serviceNames[e]+(R.data.social_uid[e]?'<span class="ds-ui-icon"></span>':"")+"</a>"+"</li>"},loginUrl:function(e,t){return t||(t={}),M.sso&&M.sso.login&&(t.sso=1,t.redirect_uri=M.sso.login),h.hostUrl+"/login/"+e+"/"+"?"+h.param(t)},bindUrl:function(e){return h.hostUrl+"/bind/"+e+"/"+(M.sso&&M.sso.login?"?"+h.param({sso:1,redirect_uri:M.sso.login}):"")},logoutUrl:function(){return h.hostUrl+"/logout/"+(M.sso&&M.sso.logout?"?"+h.param({sso:1,redirect_uri:M.sso.logout}):"")},likePost:function(e){return'<a class="ds-post-likes" href="javascript:void(0);"><span class="ds-ui-icon"></span>'+b.like+(e.likes>0?"("+e.likes+")":"")+"</a>"},ctxPost:function(e,t){var n=P(e);return'<li class="ds-ctx-entry" data-post-id="'+e.post_id+'"><div class="ds-avatar">'+D.avatar(n)+'</div><div class="ds-ctx-body"><div class="ds-ctx-head">'+D.userAnchor(n)+D.timeHtml(e.created_at,e.url)+(t>=0?'<div class="ds-ctx-nth" title="'+h.fullTime(e.created_at)+'">'+(t+1)+b.floor+"</div>":"")+'</div><div class="ds-ctx-content">'+e.message+(t>=0?'\u3000\u3000\u3000\u3000\u3000\u3000\u3000<div class="ds-comment-actions'+(e.vote>0?" ds-post-liked":"")+'">'+D.likePost(e)+' <a class="ds-post-reply" href="javascript:void(0);"><span class="ds-ui-icon"></span>'+b.reply+"</a>"+"</div>":"")+"</div></div></li>"}},P=function(e){var t=V[e.author_id]&&V[e.author_id].data||e.author;return{user_id:e.author_id||t&&t.user_id,name:e.author_name||t&&t.name,url:e.author_url||t&&t.url,avatar_url:e.author_avatar_url||t&&t.avatar_url}},H=function(e){var t=[];for(var n in e)t.push('<input type="hidden" name="'+n+'" value="'+a(e[n])+'" />');return t.join("\n")};for(;O<A.length;O++)h[A[O]]=function(e){return function(t,n){n=n||{},n.type=e,t&&!g[t]&&(g[t]=n),h.initSelector&&h.initSelector(t,n)}}(A[O]),h["create"+A[O]]=function(e){return function(t,r){var i=n.createElement(t);for(var s in r)i.setAttribute("data-"+s,r[s]);return h[e](i),i}}(A[O]);h.RecentCommentsWidget=h.RecentComments;var B=0,j=h.Class=function(){};j.extend=function(e){function r(){!B&&this.init&&this.init.apply(this,arguments)}B=1;var t=new this;B=0;for(var n in e)t[n]=e[n];return r.prototype=t,r.prototype.constructor=r,r.extend=arguments.callee,r};var F=h.Event=j.extend({on:function(e,n){var r=this.handlers||(this.handlers={});return r[e]===t&&(r[e]=[]),r[e].push(n),this},trigger:function(e,t){var n=(this.handlers||(this.handlers={}))[e];if(n)for(var r=0;r<n.length;r++)if(n[r].call(this,t)===!1)break;return this}}),I=h.Model=F.extend({init:function(e){this.data=e},reset:function(e){this.data=e,this.trigger("reset")},remove:function(e){this.data.splice(e,1),this.trigger("reset")},set:function(e,n){if(n===t)for(var r in e)this.data[r]=e[r];else this.data[e]=n;this.trigger("reset")}}),q=h.site=new I,R=h.visitor=new I,U=h.unreadComments=new I,z=h.unreadNotifications=new I,W=h.threads={},X=h.postPool={},V=h.users={};h.loaded.jQuery&&(h.jQuery=e.jQuery),h.require("jQuery",function(){function tt(e,t,n){var i=n.order=="asc",s=n.formPosition=="top",o=r(D.post(t,n)).hide()[i?"appendTo":"prependTo"](e);o.slideDown(function(){}),s==i&&h.scrollTo(o)}function nt(e,t){var n;this.delegate("a.ds-post-likes","click",function(e){if(J())return rt(),!1;var t=r(this).parent();return liked=t.hasClass("ds-post-liked"),matches=r(this).html().match(/\((\d+)\)/),likes=(matches?parseInt(matches[1]):0)+(liked?-1:1),E("/api/posts/vote",{post_id:t.closest(".ds-ctx-entry, .ds-post-self").attr("data-post-id"),vote:liked?0:1},r.noop),r(this).html(r(this).html().replace(/\(\d+\)/,"")+(likes?"("+likes+")":"")),t[liked?"removeClass":"addClass"]("ds-post-liked"),!1}).delegate("a.ds-post-repost","click",function(t){if(J())return t.stopPropagation(),rt(),!1;var n=r(this).closest(".ds-post-self"),i=X[n.attr("data-post-id")],s=n.data("source");return h.repostDialog(i,"",e),!1}).delegate("a.ds-comment-context, .ds-avatar, .ds-user-name","mouseenter",function(t){var n=this;if(bubbleOutTimer&&G.owner==n)clearTimeout(bubbleOutTimer),bubbleOutTimer=0;else{var i=r(n);Z=setTimeout(function(){Z=0,G.owner=n,et();var t=i.offset(),r=e.el.offset(),s=i.innerWidth()/2,o=e.el.innerHeight()-(t.top-r.top)+6,u=t.left-r.left-35+(s>35?35:s);try{if(i.hasClass("ds-comment-context"))Y.attr("id","ds-ctx-bubble").attr("data-post-id",i.attr("data-post-id")).html('<ul id="ds-ctx">'+D.ctxPost(X[i.attr("data-parent-id")].data)+"</ul>"+'<div class="ds-bubble-footer"><a class="ds-ctx-open" href="javascript:void(0);">\u67e5\u770b\u5bf9\u8bdd</a></div>');else if(i.hasClass("ds-avatar")||i.hasClass("ds-user-name")){var a={},f=a.user_id=i.attr("data-user-id");if(!f)throw"no info";Y.attr("id","ds-user-card").attr("data-user-id",f).empty(),V[f]?Y.html(D.userInfo(V[f].data)):w("/api/users/profile",st(a),function(e){var t=e.response;V[f]?V[f].set(t):V[f]=new I(t),G.owner==n&&Y.html(D.userInfo(t))})}G.css({bottom:o,left:u}).appendTo(e.innerEl)}catch(l){G.detach()}},200)}}).delegate("a.ds-comment-context, .ds-avatar, .ds-user-name","mouseleave",function(){Z?(clearTimeout(Z),Z=0):bubbleOutTimer||bubbleOut()}).delegate("a.ds-post-delete","click",function(t){if(confirm("\u786e\u5b9a\u8981\u5220\u9664\u8fd9\u6761\u8bc4\u8bba\u5417\uff1f")){var n=r(this).closest(".ds-post-self");E("/api/posts/remove",{post_id:n.attr("data-post-id")},r.noop),n.parent().fadeOut(200,function(){var t=e.el.find(".ds-comments-tab-duoshuo span.ds-highlight");t.html(parseInt(t.html())-Math.max(r(this).parent(".ds-children").find(".ds-post-self").length,1)),r(this).remove()})}return!1}).delegate("a.ds-post-report","click",function(e){if(confirm("\u786e\u5b9a\u8981\u4e3e\u62a5\u8fd9\u6761\u8bc4\u8bba\u5417\uff1f")){var t=r(this).closest(".ds-post-self");E("/api/posts/report",{post_id:t.attr("data-post-id")},r.noop),alert("\u611f\u8c22\u60a8\u7684\u53cd\u9988\uff01")}return!1}).delegate("a.ds-post-reply","click",function(i){var s=r(this),o=s.closest(".ds-comment-actions");if(o.hasClass("ds-reply-active"))n.el.fadeOut(200,function(){r(this).detach()}),o.removeClass("ds-reply-active");else{var u=s.closest(".ds-ctx-entry, .ds-post-self");n?n.actionsBar.removeClass("ds-reply-active"):(n=new x.Replybox(e),n.render(!0).el.addClass("ds-inline-replybox").detach()),n.el.find("[name=parent_id]").val(u.attr("data-post-id")),n.el.appendTo(s.closest(".ds-ctx-body, .ds-comment-body")).fadeIn(200).find("textarea").focus(),n.actionsBar=o.addClass("ds-reply-active"),t.max_depth<=1?n.postList=e.postList.el:(n.postList=u.siblings(".ds-children"),n.postList[0]||(n.postList=r('<ul class="ds-children"></ul>').insertAfter(u)))}return!1}).delegate("a.ds-weibo-comments","click",function(e){var n=r(this).closest(".ds-post-self"),i=n.attr("data-post-id"),s=n.data("source");if(n.attr("data-root-id")==0){var o=n.siblings(".ds-children");o[0]?o.remove():(o=r('<ul class="ds-children"></ul>').insertAfter(n),w("/api/posts/listComments",st({post_id:i}),function(e){c(e),o.append(r.map(e.response,function(e){return D.post(e,t)}).join(""))}))}return!1}).delegate("a.ds-weibo-reposts","click",function(t){var n=r(this).closest(".ds-post-self"),i=X[n.attr("data-post-id")],s=i.data.source;if(!R.data.social_uid[s=="qqt"?"qq":s]){rt(s);return}var o=i.data.root_id,u=o!="0"?X[o]:i,a="";if(o!="0"){var f=P(i.data);a=(s=="weibo"?"//@"+f.name:"|| @"+f.qqt_account)+":"+i.data.message}return h.repostDialog(u,a,e),!1})}function rt(t){t?e.location.href=D[J()?"loginUrl":"bindUrl"](t):N("<h2>\u793e\u4ea4\u5e10\u53f7\u767b\u5f55</h2>"+D.serviceList()+D.additionalServices()).el.find(".ds-dialog").css("width","300px")}function st(e){var t={require:"site,visitor,serverTime,lang"+(it++?"":",unreadComments,unreadNotifications,log,extraCss"),referer:n.referrer};for(var r in t)if(!d||encodeURIComponent(t[r]).length<200)e[r]=t[r];return e}var r=h.jQuery,i=r(e),u=r(n),c=h.loadRequire=function(e){e.serverTime&&(o=(new Date).getTime()-e.serverTime*1e3),e.visitor&&R.reset(e.visitor),e.site&&q.reset(e.site),e.lang&&r.extend(b,e.lang);if(e.stylesheets)for(var t=0;t<e.stylesheets.length;t++)h.injectStylesheet(e.stylesheets[t]);e.style&&h.setCustomStyle((e.style||"")+h.compileStyle(M.component_style)),e.unreadComments&&U.reset(e.unreadComments),e.unreadNotifications&&z.reset(e.unreadNotifications)},T=function(e){e.stopPropagation()},C=function(e){(e.ctrlKey&&e.which==13||e.which==10)&&r(this.form).trigger("submit")},A=function(e){var t=r(this);t.height(Math.max(54,t.next(".ds-hidden-text").text(this.value).height()+27))},O=function(e){m("transition")||e.addClass("ds-no-transition"),d&&e.addClass("ds-ie6"),r.support.opacity||e.addClass("ds-no-opacity")},B=function(e){if(!v.placeholder){var t=e.attr("placeholder");e.val(t).focus(function(){this.value===t&&(this.value="")}).blur(function(){this.value===""&&(this.value=t)})}return e};_()||r(_);if(e.postMessage){var j=function(t){if(t.origin==="http://duoshuo.com")switch(t.data.type){case"login":e.location.href=t.data.redirectUrl;break;default:}};e.addEventListener?e.addEventListener("message",j,!1):e.attachEvent&&e.attachEvent("onmessage",j)}h.scrollTo=function(e){var t=e.offset().top;(t<i.scrollTop()||t>i.scrollTop()+i.height())&&r("html, body").animate({scrollTop:t-40},200,"swing")},h.toJSON=function(e){var t=/\r?\n/g,n=/^(?:color|date|datetime|datetime-local|email|hidden|month|number|password|range|search|tel|text|time|url|week)$/i,i=/^(?:select|textarea)/i,s=e.map(function(){return this.elements?r.makeArray(this.elements):this}).filter(function(){return this.name&&!this.disabled&&(this.checked||i.test(this.nodeName)||n.test(this.type))}).map(function(e,n){var i=r(this).val();return i==null?null:r.isArray(i)?r.map(i,function(e,r){return{name:n.name,value:e.replace(t,"\r\n")}}):{name:n.name,value:i.replace(t,"\r\n")}}).toArray(),o={};return r.each(s,function(){o[this.name]=this.value}),o};var K=h.Widget=F.extend({init:function(e,t){this.el=e,this.options=t||{},this.render()},render:function(){},reset:function(){},load:function(e){switch(e.code){case 0:c(e),this.onload(e);break;default:this.onError(e)}},onload:function(e){this.el.html(D[this.tmpl].call(D,e.response,r.extend(this.options,e.options)))},onError:function(e){k("\u51fa\u9519\u5566("+e.code+"): "+e.errorMessage),e.errorTrace&&k(e.errorTrace)}}),Q=function(e){var t={"unread-comments":{title:"\u65b0\u7559\u8a00\u53ca\u56de\u590d",model:U,tmpl:function(e){return'<li data-thread-id="'+e.thread.thread_id+'">'+r.map(e.authors,D.userAnchor).join("\u3001")+' \u5728 <a class="ds-read" href="'+e.thread.url+'#comments" target="_blank">'+(e.thread.title||"\u65e0\u6807\u9898")+'</a> \u4e2d\u56de\u590d\u4e86\u4f60 <a class="ds-delete ds-read" title="\u77e5\u9053\u4e86" href="javascript:void(0)">\u77e5\u9053\u4e86</a></li>'},read:function(e){var t=e.attr("data-thread-id");E("/api/threads/read",{thread_id:t},r.noop),r.each(U.data,function(e,n){n.thread.thread_id==t&&U.remove(e)})}},"unread-notifications":{title:"\u7cfb\u7edf\u6d88\u606f",model:z,tmpl:function(e){return'<li data-notification-id="'+e.notification_id+'" data-notification-type="'+e.type+'">'+e.content+' <a class="ds-delete ds-read" title="\u77e5\u9053\u4e86" href="javascript:void(0)">\u77e5\u9053\u4e86</a></li>'},read:function(e){var t=e.attr("data-notification-id");E("/api/notifications/read",{notification_id:t},r.noop),r.each(z.data,function(e,n){n.notificationId==t&&z.remove(e)})}}}[e],n=N("<h2>"+t.title+"</h2>"+'<ul class="ds-unread-list">'+r.map(t.model.data,t.tmpl).join("\n")+"</ul>");n.on("close",h.resetNotify);var i=n.el.find(".ds-unread-list").delegate(".ds-delete","click",function(e){return r(this).parent().remove(),i.children().length===0&&n.close(),!1}).delegate(".ds-read","click",function(e){t.read(r(this).parent())});r("#ds-notify").hide()};h.resetNotify=function(){var e=r("#ds-notify"),t=U.data?U.data.length:0,i=z.data?z.data.length:0;e[0]||(e=r('<div id="ds-notify"></div>').css({hidden:{display:"none"},"top-right":{top:"24px",right:"24px"},"bottom-right":{bottom:"24px",right:"24px"}}[q.data.notify_position]).delegate(".ds-notify-unread a","click",function(e){return Q(r(this).data("type")),!1}).appendTo(n.body)),e.html('<div id="ds-reset"><a class="ds-logo" href="http://duoshuo.com/" target="_blank" title="\u591a\u8bf4"></a><ul class="ds-notify-unread"><li'+(t?"":' style="display:none;"')+'><a data-type="unread-comments" href="javascript:void(0);">\u4f60\u6709'+t+"\u6761\u65b0\u56de\u590d</a></li><li"+(i?"":' style="display:none;"')+'><a data-type="unread-notifications" href="javascript:void(0);">\u4f60\u6709'+i+"\u6761\u7cfb\u7edf\u6d88\u606f</a></li></ul></div>")[t+i&&!r(".ds-dialog").length?"show":"hide"]()},U.on("reset",h.resetNotify),z.on("reset",h.resetNotify),D.replybox=function(e,t){var n=e.options,r=R.data,i=[],s="",o,u={thread_id:e.threadId,parent_id:""};for(var f in r.repostOptions)r.repostOptions[f]&&(i.push(f),o=1),s+=D.serviceIcon(f,r.repostOptions[f]);return'<div class="ds-replybox"><a class="ds-avatar"'+(J()?' href="javascript:void(0);" onclick="return false"':' href="'+h.REMOTE+'/settings/avatar/" target="_blank" title="\u8bbe\u7f6e\u5934\u50cf"')+">"+D.avatarImg(r)+"</a>"+'<form method="post">'+H(u)+(r.user_id?"":'<input type="hidden" name="author_name" value="'+a(r.name)+'" /><input type="hidden" name="author_email" value="'+a(r.email)+'" /><input type="hidden" name="author_url" value="'+a(r.url)+'" />')+'<div class="ds-textarea-wrapper ds-rounded-top">'+'<textarea name="message" title="Ctrl+Enter\u5feb\u6377\u63d0\u4ea4" placeholder="'+a(b.leave_a_message)+'"></textarea>'+'<pre class="ds-hidden-text"></pre>'+"</div>"+'<div class="ds-post-toolbar">'+'<div class="ds-post-options ds-gradient-bg">'+(J()?n.deny_anonymous?"":'<span class="ds-sync">\u4e0d\u60f3\u767b\u5f55\uff1f\u76f4\u63a5\u70b9\u51fb\u53d1\u5e03\u5373\u53ef\u4f5c\u4e3a\u6e38\u5ba2\u7559\u8a00\u3002</span>':s?'<span class="ds-sync"><input id="ds-sync-checkbox'+(t?"-inline":"")+'" type="checkbox" name="repost" '+(o?'checked="checked" ':"")+'value="'+i.join(",")+'"> <label for="ds-sync-checkbox'+(t?"-inline":"")+'">'+b.share_to+"</label>"+s+"</span>":"")+"</div>"+'<button class="ds-post-button" type="submit">'+a(b.post)+"</button>"+'<div class="ds-toolbar-buttons">'+(n.use_smilies?'<a class="ds-toolbar-button ds-add-emote" title="\u63d2\u5165\u8868\u60c5"></a>':"")+(n.use_images?'<a class="ds-toolbar-button ds-add-image" title="\u63d2\u5165\u56fe\u7247"></a>':"")+"</div>"+"</div>"+"</form>"+"</div>"},x.Replybox=function(e){this.embedThread=e},x.Replybox.prototype={render:function(e){function S(e){e.data("submitting",!0),e.find(".ds-post-button").addClass("ds-waiting").html(b.posting)[0].disabled=!0}function T(e){e.data("submitting",!1),e.find(".ds-post-button").removeClass("ds-waiting").html(b.post)[0].disabled=!1}var t=this,i=t.embedThread,s=i.options,o=function(e){h.require("smilies",r.noop)},u=t.el=r(D.replybox(i,e)).click(o),a=u.find("form"),c=a.find("input[type=checkbox]")[0],p=a.find("a.ds-service-icon"),d=B(a.find("textarea")).focus(o).keyup(C).keyup(A).bind("focus mousedown mouseup keyup",l),m=u.find(".ds-add-emote").click(function(e){var i=h.smiliesTooltip;return m.toggleClass("ds-expanded").hasClass("ds-expanded")?(i||(i=h.smiliesTooltip=new x.SmiliesTooltip,i.render(),h.require("smilies",function(){i.reset("\u5fae\u535a-\u9ed8\u8ba4")})),i.replybox=t,i.el.appendTo(n.body).css({top:t.el.offset().top+t.el.outerHeight()+4+"px",left:t.el.find(".ds-textarea-wrapper").offset().left+"px"}),r(n.body).click(y)):y(e),!1}),g=u.find(".ds-add-image").click(function(e){var t=d[0],r=t.value,i="\u8bf7\u8f93\u5165\u56fe\u7247\u5730\u5740",s='<img src="'+i+'" />';if(n.selection){t.value=r.substring(0,f.start)+s+r.substring(f.end,r.length),t.value=t.value.replace("\u8bf4\u70b9\u4ec0\u4e48\u5427 ...",""),t.focus();var o=n.selection.createRange();o.collapse(),o.findText(i),o.select()}else{t.value=r.substring(0,t.selectionStart)+s+r.substring(t.selectionEnd);var u=t.value.search(i);t.setSelectionRange(u,u+i.length),t.focus()}e.preventDefault()}),y=t.hideSmilies=function(e){m.removeClass("ds-expanded"),h.smiliesTooltip.el.detach(),r(n.body).unbind("click",y)},w=function(e,t){var n=N('<div class="ds-dialog-left"><h2>\u793e\u4ea4\u5e10\u53f7\u767b\u5f55</h2>'+D.serviceList()+D.additionalServices()+"</div>"+(s.deny_anonymous?"":'<div class="ds-dialog-right"><h2>\u4f5c\u4e3a\u6e38\u5ba2\u7559\u8a00</h2><form><div class="ds-input"><input type="text" name="name" id="ds-dialog-name" value="'+e[0].author_name.value+'" required />'+'<label for="ds-dialog-name">\u540d\u5b57(\u5fc5\u586b)</label>'+"</div>"+'<div class="ds-input">'+'<input type="text" name="email" id="ds-dialog-email" value="'+e[0].author_email.value+'" required />'+'<label for="ds-dialog-email">\u90ae\u7bb1('+(s.require_email?"\u5fc5\u586b":"\u5fc5\u586b")+")</label>"+"</div>"+'<div class="ds-input">'+'<input type="text" name="url" id="ds-dialog-url" value="'+(e[0].author_url.value||"http://")+'" />'+'<label for="ds-dialog-url">\u7f51\u5740(\u53ef\u9009)</label>'+"</div>"+'<button type="submit">\u53d1\u5e03</button>'+"</form>"+"</div>"));n.el.find(".ds-dialog").css("width",s.deny_anonymous?"300px":"570px");if(!s.deny_anonymous){n.el.find(".ds-dialog-body").css("height","230px");var r=n.el.find("form");r.submit(function(i){var s=r.find("input[name=name]").val(),o=r.find("input[name=email]").val(),u=r.find("input[name=url]").val();return o.match(/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/)?(e.find("input[name=author_name]").val(s),e.find("input[name=author_email]").val(o),e.find("input[name=author_url]").val(u),t(),n.close(),!1):(alert("\u8bf7\u8f93\u5165\u4e00\u4e2a\u6709\u6548\u7684email\u5730\u5740."),!1)}),r.find("input[name=name]")[0].focus()}};s.deny_anonymous&&d.focus(function(e){if(J()){w(a,k);var t=function(e){e.stopPropagation(),d.unbind("click",t)};d.click(t)}return!1});var k=function(){S(a),E("/api/posts/create",h.toJSON(a),function(e){var n=e.response;X[n.post_id]=new I(n),tt(t.postList,n,s);var r=i.el.find(".ds-comments-tab-duoshuo span.ds-highlight");r.html(parseInt(r.html())+1),d.val("").trigger("keyup"),T(a),u.hasClass("ds-inline-replybox")&&(u.detach(),t.actionsBar.removeClass("ds-reply-active")),v.localStorage("D")&&localStorage.removeItem("messageTempContent"+i.threadId)},function(e){T(a),alert(e.errorMessage)})};a.submit(function(e){if(a.data("submitting"))return!1;var t=r.trim(a[0].message.value);return t==""||!v.placeholder&&t==d.attr("placeholder")?(alert("\u60a8\u8fd8\u6ca1\u5199\u5185\u5bb9\u5462"),!1):(J()?w(a,k):k(),!1)});var L=function(e){var t=r(e).attr("data-service");return r(e).hasClass("ds-"+t+"-active")?t:null};return p.click(function(){var e=r(this);return service=e.attr("data-service"),e.toggleClass("ds-"+service+"-active"),c.value=r.map(p,L).join(","),c.checked=c.value!="",!1}),r(c).change(function(){var e=this.checked;p.each(function(){r(this)[e?"addClass":"removeClass"]("ds-"+r(this).attr("data-service")+"-active")}),this.value=r.map(p,L).join(",")}),this}},x.Dialog=F.extend({init:function(e,n){(this.el=r("#ds-wrapper"))[0]||O(this.el=r('<div id="ds-wrapper"></div>')),this.options=r.extend({width:600},n),e!==t&&r(e).attr("id","ds-reset").appendTo(this.el)},open:function(){var e=this;e.el.hide().appendTo(n.body).fadeIn(200),d&&e.el.css("top",i.scrollTop()+100),e.el.show().find(".ds-dialog").delegate("a.ds-dialog-close","click",function(t){return e.close(),!1}).click(T);var t=function(t){if(t.which==27)return e.close(),!1},s=function(t){return e.close(),!1};return u.keydown(t),r(n.body).click(s),e.close=function(i){u.unbind("keydown",t),r(n.body).unbind("click",s),e.el.fadeOut(200,function(){r(this).remove()}),e.trigger("close")},e}}),D.likePanel=function(e){return e.likes?'<span class="ds-highlight">'+e.likes+"</span> \u4eba\u559c\u6b22":""},D.likeTooltip=function(){var e={qzone:"QQ\u7a7a\u95f4",weibo:"\u65b0\u6d6a\u5fae\u535a",qqt:"\u817e\u8baf\u5fae\u535a",renren:"\u4eba\u4eba\u7f51",kaixin:"\u5f00\u5fc3\u7f51",douban:"\u8c46\u74e3\u7f51",baidu:"\u767e\u5ea6\u641c\u85cf",netease:"\u7f51\u6613\u5fae\u535a",sohu:"\u641c\u72d0\u5fae\u535a"},t=[];for(var n in e)t.push('<li><a class="ds-share-to-'+n+" ds-service-link ds-"+n+'-active" href="javascript:void(0)">'+e[n]+"</a></li>");var r=Math.ceil(t.length/2);return'<div class="ds-like-tooltip ds-rounded"><p>\u5f88\u9ad8\u5174\u4f60\u80fd\u559c\u6b22\uff0c\u5206\u4eab\u4e00\u4e0b\u5427\uff1a</p><ul>'+t.slice(0,r).join("")+"</ul><ul>"+t.slice(r).join("")+'</ul><p class="ds-like-tooltip-footer"><a class="ds-like-tooltip-close">\u7b97\u4e86</a></p></div>'},x.Meta=function(e){this.embedThread=e},x.Meta.prototype={render:function(){var i=this,s=i.embedThread,o=s.data,u=i.el=r('<div class="ds-meta"><a href="javascript:void(0)" class="ds-like-thread-button ds-rounded'+(o.user_vote>0?" ds-thread-liked":"")+'"><span class="ds-ui-icon"></span>'+' <span class="ds-thread-like-text">'+(o.user_vote>0?"\u5df2\u559c\u6b22":"\u559c\u6b22")+'</span><span class="ds-thread-cancel-like">\u53d6\u6d88\u559c\u6b22</span></a><span class="ds-like-panel"></span></div>'),a=u.find(".ds-like-thread-button").click(function(f){var l=a.hasClass("ds-thread-liked");E("/api/threads/vote",{thread_id:s.threadId,vote:l?0:1},function(e){r.each(e.thread,function(e,t){o[e]=t}),i.resetLikePanel()}),a.toggleClass("ds-thread-liked"),a.find(".ds-thread-like-text").text(l?"\u559c\u6b22":"\u5df2\u559c\u6b22");var c=function(e){i.tooltip.detach(),r(n.body).unbind("click",c)};return l?i.tooltip&&c(f):(i.tooltip===t&&(i.tooltip=r(D.likeTooltip(o)).click(T).delegate("a","click",function(t){switch(this.className){case"ds-like-tooltip-close":c(t);break;default:var n=this.className.match(/ds\-share\-to\-(\w+)/)[1];e.open(h.hostUrl+"/share-proxy/?"+h.param({service:n,thread_id:s.threadId}),"_blank","height=500,width=600,top=0,left=0,toolbar=no,menubar=no,resizable=yes,location=yes,status=no")}return!1})),i.tooltip.appendTo(s.innerEl).css({top:u.position().top+u.outerHeight()-4+"px",left:0}),r(n.body).click(c)),!1});return i.resetLikePanel(),J()&&u.hide(),i},resetLikePanel:function(){this.el.find(".ds-like-panel").html(D.likePanel(this.embedThread.data))}},D.postListHead=function(e){var t=e.data,n=e.options
;return'<div class="ds-comments-info"><div class="ds-sort"><a class="ds-order-desc">'+b.latest+'</a><a class="ds-order-asc">'+b.earliest+'</a><a class="ds-order-hot">'+b.hottest+'</a></div><ul class="ds-comments-tabs"><li class="ds-tab"><a class="ds-comments-tab-duoshuo ds-current" href="javascript:void(0);"><span class="ds-highlight">'+t.comments+"</span>\u6761\u8bc4\u8bba</a></li>"+(n.show_reposts&&t.reposts?'<li class="ds-tab"><a class="ds-comments-tab-repost" href="javascript:void(0);"><span class="ds-highlight">'+t.reposts+"</span>\u6761\u8f6c\u8f7d</a></li>":"")+(n.show_weibo&&t.weibo_reposts?'<li class="ds-tab"><a class="ds-comments-tab-weibo" href="javascript:void(0);"><span class="ds-highlight">'+t.weibo_reposts+"</span>\u6761\u65b0\u6d6a\u5fae\u535a</a></li>":"")+(n.show_qqt&&t.qqt_reposts?'<li class="ds-tab"><a class="ds-comments-tab-qqt" href="javascript:void(0);"><span class="ds-highlight">'+t.qqt_reposts+"</span>\u6761\u817e\u8baf\u5fae\u535a</a></li>":"")+"</ul>"+"</div>"},x.PostListHead=function(e){this.embedThread=e},x.PostListHead.prototype={render:function(){var e=this.embedThread,t=e.options,n=e.postList,i=this.el=r(D.postListHead(e)),s=i.find("ul.ds-comments-tabs").delegate(".ds-tab a","click",function(t){s.find("a.ds-current").removeClass("ds-current"),n.params.page=1;var i=t.currentTarget;switch(i.className){case"ds-comments-tab-duoshuo":n.params.source="duoshuo",e.replybox.el.show();break;case"ds-comments-tab-repost":n.params.source="repost",e.replybox.el.hide();break;case"ds-comments-tab-weibo":n.params.source="weibo",e.replybox.el.hide();break;case"ds-comments-tab-qqt":n.params.source="qqt",e.replybox.el.hide();break;default:}return r(i).addClass("ds-current"),n.refetch(),!1}),o=i.find(".ds-sort").delegate("a","click",function(e){return o.find("a.ds-current").removeClass("ds-current"),n.params.order=t.order=this.className.replace("ds-order-",""),n.params.page=1,n.refetch(),r(this).addClass("ds-current"),!1});o.find(".ds-order-"+n.params.order).addClass("ds-current")}},x.Paginator=function(e){e&&(this.el=e.el||r('<div class="ds-paginator"></div>'),e.collection&&(this.collection=e.collection))},x.Paginator.prototype={reset:function(e){function i(e){r.push('<a data-page="'+e+'" href="javascript:void(0);">'+e+"</a>")}var t=this.collection.params.page||1,n,r=[];if(t>1){i(1),n=t>4?t-2:2,n>2&&r.push('<span class="page-break">...</span>');for(;n<t;n++)i(n)}r.push('<a data-page="'+t+'" href="javascript:void(0);" class="ds-current">'+t+"</a>");if(t<e.pages){for(n=t+1;n<=t+4&&n<e.pages;n++)i(n);n<e.pages&&r.push('<span class="page-break">...</span>'),i(e.pages)}this.el.html('<div class="ds-border"></div>'+r.join(" ")),this.el[e.pages>1?"show":"hide"]()},render:function(){var e=this,t=e.collection;return e.el.delegate("a","click",function(n){return t.params.page=parseInt(this.innerHTML),t.refetch(),e.el.find(".ds-current").removeClass("ds-current"),r(this).addClass("ds-current"),!1}),this}},D.smiliesTooltip=function(e){var t='<div id="ds-smilies-tooltip"><ul class="ds-smilies-tabs">';for(var n in e)t+="<li><a>"+n+"</a></li>";return t+'</ul><div class="ds-smilies-container"></div></div>'},h.addSmilies=function(e,t){var n=h.smiliesTooltip;n&&n.el.find("ul.ds-smilies-tabs").append("<li><a>"+e+"</a></li>"),h.smilies[e]=t},x.SmiliesTooltip=function(){},x.SmiliesTooltip.prototype={render:function(){var e=this,t=e.el=r(D.smiliesTooltip(L));return t.click(T).find("ul.ds-smilies-tabs").delegate("a","click",function(t){e.reset(this.innerHTML)}),t.find(".ds-smilies-container").delegate("img","click",function(t){var r=e.replybox,i=r.el.find("textarea")[0],s=i.value;if(n.selection){i.value=s.substring(0,f.start)+this.title+s.substring(f.end,s.length),i.value=i.value.replace(b.leave_a_message,""),i.focus();var o=n.selection.createRange();o.moveStart("character",f.start+this.title.length),o.collapse(),o.select()}else{var u=i.selectionStart+this.title.length;i.value=s.substring(0,i.selectionStart)+this.title+s.substring(i.selectionEnd),i.setSelectionRange(u,u)}r.hideSmilies(),i.focus()}),this},reset:function(e){var t=this.el.find("ul.ds-smilies-tabs");t.find("a.ds-current").removeClass("ds-current"),t.find("a").filter(function(){return this.innerHTML==e}).addClass("ds-current");var n="<ul>";return r.each(L[e],function(t,r){var i=e.indexOf("\u5fae\u535a")===0?"http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/"+r.replace("_org","_thumb"):h.STATIC+"/images/smilies/"+r;e==="WordPress"&&(t=" "+t+" "),n+='<li><img src="'+i+'" title="'+a(t)+'" /></li>'}),n+="</ul>",this.el.find(".ds-smilies-container").html(n),this}},D.post=function(e,t){var n=P(e),i=n.user_id?' data-user-id="'+n.user_id+'"':"",s=n.qqt_account||"",o=D.timeHtml(e.created_at,e.url),u=e.parents||[];switch(e.source){case"duoshuo":o+='<a class="ds-post-reply" href="javascript:void(0);"><span class="ds-ui-icon"></span>'+b.reply+"</a>"+D.likePost(e)+'<a class="ds-post-report" href="javascript:void(0);"><span class="ds-ui-icon"></span>'+b.report+"</a>"+(e.privileges["delete"]?'<a class="ds-post-delete" href="javascript:void(0);"><span class="ds-ui-icon"></span>'+b["delete"]+"</a>":"");break;case"qqt":case"weibo":o+='<a class="ds-weibo-comments" href="javascript:void(0);">'+b.comments+(e.type.match(/\-comment$/)?"":'(<span class="ds-count">'+e.comments+"</span>)")+"</a>"+'<a class="ds-weibo-reposts" href="javascript:void(0);">'+b.reposts+(e.type.match(/\-comment$/)?"":'(<span class="ds-count">'+e.reposts+"</span>)")+"</a>";break;default:}return'<li class="ds-post" data-post-id="'+e.post_id+'"><div class="ds-post-self" data-post-id="'+e.post_id+'" data-thread-id="'+e.thread_id+'" data-root-id="'+e.root_id+'" data-source="'+e.source+'"><div class="ds-avatar"'+i+">"+D.avatar(n)+(h.sourceName[e.source]?D.serviceIcon(e.source,1):"")+'</div><div class="ds-comment-body"><div class="ds-comment-header">'+(n.url?'<a class="ds-user-name ds-highlight" data-qqt-account="'+s+'" href="'+a(n.url)+'" rel="nofollow" target="_blank"'+i+">"+a(n.name)+"</a>":'<span class="ds-user-name"'+i+' data-qqt-account="'+s+'">'+a(n.name)+"</span>")+"</div>"+(t.max_depth==1&&t.show_context&&u.length?'<ol id="ds-ctx">'+r.map(u,function(e,t){return X[e]?D.ctxPost(X[e].data,t):""}).join("")+"</ol>":"")+"<p>"+(u.length>=t.max_depth-1&&(!t.show_context||t.max_depth>1)&&e.parent_id&&X[e.parent_id]?'<a class="ds-comment-context" data-post-id="'+e.post_id+'" data-parent-id="'+e.parent_id+'"><span class="ds-ui-icon"></span>'+b.reply_to+a(P(X[e.parent_id].data).name)+": </a>":"")+e.message+'</p><div class="ds-comment-footer ds-comment-actions'+(e.vote>0?" ds-post-liked":"")+'">'+o+"</div></div></div>"+(t.max_depth>1&&(e.childrenArray||e.children)&&e.source!="weibo"&&e.source!="qqt"?'<ul class="ds-children">'+r.map(e.childrenArray||e.children,function(e){return X[e]?D.post(X[e].data,t):""}).join("")+"</ul>":"")+"</li>"};var G=r('<div id="ds-bubble"><div class="ds-bubble-content"></div><div class="ds-arrow ds-arrow-down ds-arrow-border"></div><div class="ds-arrow ds-arrow-down"></div></div>'),Y=G.find(".ds-bubble-content").delegate("a.ds-ctx-open","click",function(e){w("/api/posts/conversation",{post_id:Y.attr("data-post-id")},function(e){t.el.find("ol").html(r.map(e.response,D.ctxPost).join("\n"))});var t=N('<h2>\u67e5\u770b\u5bf9\u8bdd</h2><ol id="ds-ctx"></ol>');return t.el.find(".ds-dialog").css("width","600px"),t.el.find(".ds-dialog-body").css({"max-height":"350px",_height:"350px","overflow-y":"auto","padding-top":"10px"}),!1}),Z=bubbleOutTimer=0,et=function(){bubbleOutTimer&&(clearTimeout(bubbleOutTimer),bubbleOutTimer=0)};bubbleOut=function(){bubbleOutTimer=setTimeout(function(){bubbleOutTimer=0,G.detach()},400)},G.hover(et,bubbleOut),D.userInfo=function(e){var t=[];return r.each(e.social_uid,function(e,n){t.push('<a href="'+h.REMOTE+"/user-proxy/"+e+"/"+n+'/" target="_blank" class="ds-service-icon ds-'+e+"-active"+'" title="'+h.sourceName[e]+'"></a>')}),'<a href="'+a(e.url)+'" class="ds-avatar" target="_blank">'+D.avatarImg(e)+'</a><a href="'+a(e.url)+'" class="ds-user-name ds-highlight" target="_blank">'+a(e.name)+"</a>"+t.join("")+'<p class="ds-user-card-meta"><a href="'+h.REMOTE+"/profile/"+e.user_id+'/" target="_blank"><span class="ds-highlight">'+e.comments+"</span>\u6761\u8bc4\u8bba</a></p>"+(e.description?'<p class="ds-user-description">'+a(e.description)+"</p>":"")},S.PostList=function(e){e&&(e.params&&(this.params=e.params),e.embedThread&&(this.embedThread=e.embedThread)),this.el=r('<ul class="ds-comments"></ul>')},S.PostList.prototype={url:"/api/posts/list",render:function(){return nt.call(this.el,this.embedThread,this.embedThread.options),this},reset:function(e){var t=this.embedThread.options;this.el.html(r.map(e,function(e){return X[e]?D.post(X[e].data,t):""}).join(""))},refetch:function(){var e=this,t=r(D.indicator()).appendTo(n.body).fadeIn(200);e.el.fadeTo(200,.5),w(e.url,e.params,function(n){$(X,n.parentPosts||n.relatedPosts),$(V,n.users),e.reset(n.newResponse||n.response),e.embedThread.paginator.reset(n.cursor),e.el.fadeTo(200,1),h.scrollTo(e.el),t.remove()})}},h.repostDialog=function(e,t,n){var r=N('<div class="ds-quote"><strong>@'+a(P(e.data).name)+"</strong>: "+e.data.message+"</div>"+"<form>"+H({post_id:e.data.post_id,service:e.data.source})+'<div class="ds-textarea-wrapper">'+'<textarea name="message" title="Ctrl+Enter\u5feb\u6377\u63d0\u4ea4" placeholder="'+a(b.repost_reason)+'">'+a(t)+"</textarea>"+'<pre class="ds-hidden-text"></pre>'+"</div>"+'<div class="ds-actions">'+'<button type="submit">'+b.repost+"</button>"+"</div>"+"</form>"),i=r.el.find("form").submit(function(e){return E("/api/posts/repost",h.toJSON(i),function(e){tt(n.postList.el,e.response,n.options);var t=n.el.find(".ds-comments-tab-"+service+" span.ds-highlight");t.html(parseInt(t.html())+1)}),r.close(),!1});return B(i.find("textarea")).keyup(C).keyup(A).focus(),!1},D.toolbar=function(e){var t=D.logoutUrl(),n=M.remote_auth?"?"+h.param({short_name:M.short_name,remote_auth:M.remote_auth}):"";return'<div class="ds-toolbar"><div class="ds-account-control"><span class="ds-ui-icon"></span> <span>\u5e10\u53f7\u7ba1\u7406</span><ul><li><a class="ds-bind-more" href="javascript:void(0);" style="border-top: none">\u7ed1\u5b9a\u66f4\u591a</a></li><li><a target="_blank" href="'+h.REMOTE+"/settings/"+n+'">'+a(b.settings)+"</a></li>"+'<li><a rel="nofollow" href="'+t+'" style="border-bottom: none">\u767b\u51fa</a></li>'+"</ul>"+"</div>"+'<div class="ds-visitor">'+(R.data.url?'<a class="ds-visitor-name" href="'+a(R.data.url)+'" target="_blank">'+a(R.data.name)+"</a>":'<span class="ds-visitor-name">'+a(R.data.name)+"</span>")+'<a class="ds-unread-comments-count" href="javascript:void(0);" title="\u65b0\u56de\u590d"></a>'+"</div>"+"</div>"},x.EmbedThread=K.extend({uri:"/api/threads/listPosts",params:"thread-id local-thread-id source-thread-id thread-key category channel-key author-key author-id url limit order form-position"+(s.match(/MSIE 6\.0/)?"":" title image thumbnail"),render:function(){var t=this.el;t.attr("id","ds-thread").append(D.waitingImg()),!t.attr("data-thread-id")&&!t.data("url")&&t.data("url",r("link[rel=canonical]").attr("href")||e.location.href.replace(/#.+/,""))},onError:function(e){this.el.html("\u8bc4\u8bba\u6846\u51fa\u9519\u5566("+e.code+"): "+e.errorMessage)},onload:function(e){var n=this,i=n.threadId=e.thread.thread_id,s=e.cursor,o=n.options=e.options,u=n.innerEl=r('<div id="ds-reset"></div>').appendTo(n.el);n.data=e.thread,$(X,e.parentPosts||e.relatedPosts),$(V,e.users),n.el.find("#ds-waiting").remove(),O(u),o.like_thread_enabled&&(n.meta=new x.Meta(n),n.meta.render().el.appendTo(u)),e.hotPosts&&e.hotPosts.length&&(n.hotPosts=new x.HotPosts(r('<div class="ds-rounded"></div>'),{max_depth:1,show_context:o.show_context}),n.hotPosts.thread=n,n.hotPosts.el.appendTo(u),n.hotPosts.onload({response:e.hotPosts,options:{}}));if(J())n.loginButtons=r(D.loginButtons()).appendTo(u),n.loginButtons.find("a.ds-more-services").click(function(){return n.loginButtons.find(".ds-additional-services").toggle(),!1});else{var a=n.toolbar=r(D.toolbar()).appendTo(u);a.find(".ds-account-control").hover(function(){r(this).addClass("ds-active")},function(){r(this).removeClass("ds-active")}),a.find("a.ds-bind-more").click(function(){return N("<h2>\u7ed1\u5b9a\u66f4\u591a\u5e10\u53f7</h2>"+D.serviceList(1)+D.additionalServices(1)+'<div style="clear:both"></div>').el.find(".ds-dialog").addClass("ds-dialog-bind-more").css("width","300px"),!1}),a.find("a.ds-unread-comments-count").click(function(e){return Q("unread-comments"),!1})}var f=n.replybox=new x.Replybox(n);u.append('<a name="respond"></a>',f.render().el);var l=f.el.find("textarea");o.message&&l.val(o.message).focus(),v.localStorage("D")&&(l.bind("focus blur keyup",function(e){var t=r(e.currentTarget).val();localStorage["messageTempContent"+i]=t}),localStorage["messageTempContent"+i]&&l.val(localStorage["messageTempContent"+i])),n.postListHead=new x.PostListHead(n),n.postList=new S.PostList({embedThread:n,params:{source:"duoshuo",thread_id:i,order:o.order,limit:o.limit}}),n.paginator=new x.Paginator({collection:n.postList}),n.postListHead.render(),n.postList.render().reset(e.newResponse||e.response),n.paginator.render().reset(s),f.postList=n.postList.el,o.formPosition=="top"?u.append(n.postListHead.el,n.postList.el,n.paginator.el):(n.loginButtons||a).before(n.postListHead.el,n.postList.el,n.paginator.el),r(D.poweredBy(o.poweredby_text)).appendTo(u),U.on("reset",function(){var e=U.data.length;u.find("a.ds-unread-comments-count").html(e).attr("title",e?"\u4f60\u6709"+e+"\u6761\u65b0\u56de\u590d":"\u4f60\u6ca1\u6709\u65b0\u56de\u590d").css("display",e?"inline":"none")}),U.data!==t&&U.trigger("reset"),z.data!==t&&z.trigger("reset")}}),D.hotPosts=function(e,t){return'<div class="ds-header ds-gradient-bg">'+b.hot_posts_title+"</div><ul>"+r.map(e,function(e){return X[e]?D.post(X[e].data,t):""}).join("")+"</ul>"},x.HotPosts=K.extend({params:"show-quote",tmpl:"hotPosts",render:function(){return this.el.attr("id","ds-hot-posts"),this},onload:function(e){K.prototype.onload.call(this,e),nt.call(this.el.find("ul"),this.thread,this.options)}}),D.commentList=function(e,t){return r.map(e,function(e){var n=P(e);return'<li class="ds-comment'+(t.show_avatars?" ds-show-avatars":"")+'" data-post-id="'+e.post_id+'">'+(t.show_avatars?'<div class="ds-avatar">'+D.avatar(n,t.avatar_size)+"</div>":"")+'<div class="ds-meta">'+D.userAnchor(n)+(t.show_time?D.timeHtml(e.created_at):"")+"</div>"+(t.show_title?'<div class="ds-thread-title">\u5728 <a href="'+a(e.thread.url+"#comments")+'">'+a(e.thread.title)+'</a> \u4e2d\u8bc4\u8bba</div><div class="ds-excerpt">'+e.message+"</div>":'<a class="ds-excerpt" title="'+a(e.thread.title)+' \u4e2d\u7684\u8bc4\u8bba" href="'+a(e.thread.url+"#comments")+'">'+e.message+"</a>")+"</li>"}).join("")},x.RecentComments=K.extend({uri:"/api/sites/listRecentPosts",params:"show-avatars show-time show-title avatar-size show-admin excerpt-length num-items channel-key",tmpl:"commentList",render:function(){this.el.attr("id","ds-recent-comments")}}),D.recentVisitors=function(e,t){return r.map(e,function(e){return'<div class="ds-avatar">'+D.avatar(e,t.avatar_size)+"</div>"}).join("")},x.RecentVisitors=K.extend({uri:"/api/sites/listVisitors",params:"show-time avatar-size num-items channel-key",tmpl:"recentVisitors",render:function(){this.el.children().detach(),this.el.attr("id","ds-recent-visitors").append(this.waitingEl=r(D.waitingImg()))}}),D.topUsers=function(e,t){return r.map(e,function(e){return'<div class="ds-avatar">'+D.avatar(e,t.avatar_size)+"<h4>"+e.name+"</h4>"+"</div>"}).join("")},x.TopUsers=K.extend({uri:"/api/sites/listTopUsers",params:"show-time avatar-size num-items channel-key",tmpl:"topUsers",render:function(){this.el.children().detach(),this.el.attr("id","ds-top-users").append(this.waitingEl=r(D.waitingImg()))}}),D.topThreads=function(e,t){return r.map(e,function(e){return'<li><a target="_blank" href="'+a(e.url)+'" title="'+e.title+'">'+e.title+"</a>"+"</li>"}).join("")},x.TopThreads=K.extend({uri:"/api/sites/listTopThreads",params:"range num-items channel-key",tmpl:"topThreads",render:function(){this.el.children().detach(),this.el.attr("id","ds-top-threads").append(this.waitingEl=r(D.waitingImg()))}}),D.loginWidget=function(){var e='<div class="ds-icons-32">';return r.each(["weibo","qq","renren","kaixin","douban","netease","sohu"],function(t,n){e+='<a class="ds-'+n+'" href="javascript:void(0)">'+h.sourceName[n]+"</a>"}),e+"</div>"},x.LoginWidget=K.extend({tmpl:"loginWidget",render:function(){var t=this.el,n={weibo:"height=600,width=760",renren:"height=322,width=420",qq:"height=445,width=504",netease:"height=645,width=810",sohu:"height=600,width=990",google:"height=440,width=600",taobao:"height=585,width=480"};t.attr("id","ds-login").html(D.loginWidget()),t.find("a").each(function(t,i){var s=i.className.replace("ds-","");if(!h.serviceNames[s])return;i.href=D.loginUrl(s),e.postMessage&&e.screen.width>800&&!v.iOS&&!v.android&&r(i).click(function(){return e.open(D.loginUrl(s,{origin:e.location.origin||"http://"+e.location.host}),"_blank",(n[s]||"height=400,width=550")+",toolbar=no,menubar=no,location=yes"),!1})}),t.find("a.ds-logout").attr("href",D.logoutUrl())}}),x.ThreadCount=K.extend({onload:function(e){var t=this.el,n=t.data("count-type")||"comments",r=e.data[n];t[t.data("replace")?"replaceWith":"html"](b[n+"_"+(r?r>1?"multiple":"one":"zero")].replace("{num}",r))}});var it=0;h.initSelector=function(t,n){var i=[];e.duoshuoQuery&&(r.isReady||!p)&&r(t).each(function(e,t){var s=r(t);if(s.data("initialized"))return;s.data("initialized",!0);var o=new x[n.type](s,n);y.push(o);if(n.type==="ThreadCount"){var u=s.attr("data-thread-key");s.attr("data-channel-key")&&(u=s.attr("data-channel-key")+":"+u),i.push(u),W[u]||(W[u]=new I({})),W[u].on("reset",function(){o.onload(this)})}else if(o.uri){var a={};r.each(o.params.split(" "),function(e,t){a[t.replace(/-/g,"_")]=s.attr("data-"+t)||s.data(t)}),w(o.uri,st(a),function(e){o.load(e)})}}),i.length&&w("/api/threads/counts",st({threads:i.join(",")}),function(e){c(e),r.extend(b,e.options),$(W,e.response)})},(h.initView=function(){r.each(g,h.initSelector)})(),r(function(){if(!M){k("\u7f3a\u5c11duoshuoQuery\u7684\u5b9a\u4e49");return}setInterval(function(){r(".ds-time").each(function(){var e=r(this).attr("datetime");e&&(this.innerHTML=h.elapsedTime(e))})},2e4),M.ondomready&&M.ondomready(),h.initView(),!it&&M.short_name&&w("/api/analytics/ping",st({}),c)})}),h.injectStylesheet(h.STATIC+h.EMBED_STYLESHEET)})(window);